# Fabric.Identity.API
A .Net Core 1.1 service that provides centralized authentication and authorization for health care applications and apis that want to participate in the Fabric ecosystem.

# Building and running
The Fabric Identity API depends on having the latest version of DOS installed properly as a prerequisite to running Fabric Identity API.

If you want to debug Fabric Identity API 

- In Fabric.Identity.API/appsettings.json, update the `HostingOptions.UseTestUsers` to be false
- Update `HostingOptions.StorageProvider` to be `SqlServer`
- Update `ConnectionStrings.IdentityDatabase` to be `Server=localhost` instead of Server=(localdb)\\mssqllocaldb
- Update `IdentityServerConfidentialClientSettings.Authority` to be `http://localhost/IdentityDev`
- Update `IdentityServerConfidentialClientSettings.ClientSecret` to be `secret`
- The `IdentityServerConfidentialClientSettings.ClientID` doesn't seem to be used when debugging and is just a placeholder
- Update the `Identity` database `ClientSecrets` table `Value` for the ClientId in the `Clients` table for `fabric-identity-client`
  The value to copy and update to `ClientSecrets.Value` is generated by running the following in powershell. Uncomment and paste into powershell, run and copy the value.
    <!--$fabricInstallerSecret = "secret"
    #$fabricInstallerSecret = [System.Convert]::ToBase64String([guid]::NewGuid().ToByteArray()).Substring(0,16)
    Write-Host "New Installer secret: $fabricInstallerSecret"
    $sha = [System.Security.Cryptography.SHA256]::Create()
    $hashedSecret = [System.Convert]::ToBase64String($sha.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($fabricInstallerSecret)))
    #Invoke-Sql -connectionString $identityDbConnectionString -sql $query -parameters @{value=$hashedSecret} | Out-Null
    $fabricInstallerSecret
    $hashedSecret-->
- In the `Metadata` database (EDWAdmin) `CatalystAdmin.DiscoveryServiceBASE` table, change the ServiceUrl for ServiceNM `IdentityService`
  to be `http://localhost/IdentityDev`
- In VS 2017 ensure the startup project is `Fabric.Identity.API` and the debug profile is set to `IIS`.
- In VS 2017 begin debugging by pressing `F5`
- In IIS, a new web application will be created `IdentityDev`.  You will need to change the app pool; I suggest changing it the the same one as Identity.
- In the new web application `IdentityDev` add the following `environmentVariable` to the web.config 
`<environmentVariable name="IdentityServerConfidentialClientSettings__ClientSecret" value="secret" />`
- From time to time, the debugger set to `IIS` will remove the https binding.  If you notice things not working, check that out.

- If you are debugging Fabric.IdentityProviderSearchService, in Fabric.Identity.API/appsettings.json, update the `IdentityProviderSearchSettings.BaseUrl` setting to point at the debug version, `http://localhost/IdPSSDev`

This will allow you to set breakpoints in the Fabric.Identity.API code via VS 2017.